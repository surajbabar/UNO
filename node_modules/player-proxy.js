var proxy = {};
var playerModel = require('player.js').player;

var observer;

proxy.createProxy = function (socket, gameMaster) {
    observer = gameMaster;
    var proxyDetails = {player: "", channel: socket};

    var performActionOnMessage = function (data) {
        var message = JSON.parse(data);
        var actions = {};

        actions["introduction"] = function () {
            proxyDetails.player = playerModel.createPlayer(message.playerName);
            gameMaster.onPlayerRegistered(proxyDetails.player);
        }
        actions["playCardAction"] = function () {
            gameMaster.onCardPlayed(message.card, message.color, proxyDetails.player);
        }
        actions["drawAction"] = function () {
            gameMaster.onPlayerDrewACard(proxyDetails.player);
        }
        actions["noActionAfterDraw"] = function () {
            gameMaster.onNoActionAfterDraw(proxyDetails.player);
        }
        actions["drawTwoAction"] = function () {
            gameMaster.onDrawTwoAction(proxyDetails.player);
        }
        actions["declaredUno"] =function(){
            gameMaster.declareUno(proxyDetails.player);
        }

        actions[message.type]();
    };

    socket.on('data', performActionOnMessage);
    return proxyDetails;
}

proxy.send = function (playerProxy, game) {
    var snapshot = {};
    game.populate(snapshot, playerProxy.player);
    playerProxy.channel.write(JSON.stringify(snapshot));
}

proxy.sendSnapshotToPlayer = function (playerProxy, game, player) {
    if (playerProxy.player != player)
        return;
    var snapshot = {};
    game.populate(snapshot, player);
    snapshot.disableDraw = true;
    playerProxy.channel.write(JSON.stringify(snapshot));
};

proxy.sendResult = function (playerProxy, result) {
    playerProxy.channel.write(JSON.stringify(result));
};


exports.proxy = proxy;