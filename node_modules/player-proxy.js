var proxy = {};
var playerModel = require('player.js').player;

var observer;

proxy.createProxy = function (socket, gameMaster) {
    observer = gameMaster;
    var proxyDetails = {player: "", channel: socket};
    socket.on('data', function (data) {
        var message = JSON.parse(data);
        if (message.type == 'introduction') {
            proxyDetails.player = playerModel.createPlayer(message.playerName);
            gameMaster.onPlayerRegistered(proxyDetails.player);
        }
        if (message.type == 'playCardAction') {
            gameMaster.onCardPlayed(message.card, message.color, proxyDetails.player);
        }
        if (message.type == 'drawAction') {
            gameMaster.onPlayerDrewACard(proxyDetails.player);
        }
        if (message.type == 'noActionAfterDraw') {
            gameMaster.onNoActionAfterDraw(proxyDetails.player);
        }
    });
    return proxyDetails;
}

proxy.send = function (playerProxy, game) {
    var snapshot = {};
    game.populate(snapshot, playerProxy.player);
    playerProxy.channel.write(JSON.stringify(snapshot));
}

proxy.sendSnapshotToPlayer = function (playerProxy, game, player) {
    if (playerProxy.player != player)
        return;
    var snapshot = {};
    game.populate(snapshot, player);
    snapshot.disableDraw = true;
    playerProxy.channel.write(JSON.stringify(snapshot));
};


exports.proxy = proxy;